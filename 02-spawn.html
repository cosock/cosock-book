<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Spawn - Cosock</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="01-cosock.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="01.1-getting-started.html"><strong aria-hidden="true">1.1.</strong> Getting Started</a></li></ol></li><li class="chapter-item expanded "><a href="02-spawn.html" class="active"><strong aria-hidden="true">2.</strong> Spawn</a></li><li class="chapter-item expanded "><a href="03-channels.html"><strong aria-hidden="true">3.</strong> Channels</a></li><li class="chapter-item expanded "><a href="04-select.html"><strong aria-hidden="true">4.</strong> Select</a></li><li class="chapter-item expanded "><a href="05.0-setwaker.html"><strong aria-hidden="true">5.</strong> Integrating with Cosock</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="05.1-bounded-channel.html"><strong aria-hidden="true">5.1.</strong> Bounded Channel: Shared</a></li><li class="chapter-item expanded "><a href="05.2-bounded-recvr.html"><strong aria-hidden="true">5.2.</strong> Bounded Channel: Recvr</a></li><li class="chapter-item expanded "><a href="05.3-bounded-sendr.html"><strong aria-hidden="true">5.3.</strong> Bounded Channel: Sendr</a></li><li class="chapter-item expanded "><a href="05.4-bounded-final.html"><strong aria-hidden="true">5.4.</strong> Bounded Channel: Finish</a></li><li class="chapter-item expanded "><a href="05.5-bounded-limits.html"><strong aria-hidden="true">5.5.</strong> Bounded Channel: Limitations</a></li></ol></li><li class="chapter-item expanded "><a href="06.0-advanced.html"><strong aria-hidden="true">6.</strong> Advanced</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="06.1-internals.html"><strong aria-hidden="true">6.1.</strong> Internals</a></li><li class="chapter-item expanded "><a href="06.2-run.html"><strong aria-hidden="true">6.2.</strong> Run</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cosock</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cosock/cosock-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/cosock/cosock-book/edit/main/src/02-spawn.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="spawn"><a class="header" href="#spawn">Spawn</a></h1>
<p>At the core of cosock is the ability to wrap any operation in a coroutine and
register that with cosock. For this cosock exports the function <code>cosock.spawn</code>. This function takes
2 arguments, the first is a function that will be our coroutine, and the second is a name for that coroutine.</p>
<p>For example, this is a simple program that will spawn a single coroutine, which will print the current
timestamp and the word &quot;tick&quot; and then sleep for 1 second in a loop forever.</p>
<pre><code class="language-lua">--basic_spawn.lua
local cosock = require &quot;cosock&quot;

cosock.spawn(function()
  while true do
    print(cosock.socket.gettime(), &quot;tick&quot;)
    cosock.socket.sleep(1)
  end
end, &quot;clock&quot;)
cosock.run()
</code></pre>
<p>The act of calling <code>cosock.spawn</code> allows us to use the non-blocking <code>cosock.socket.sleep</code> function. This means
we could extend our application to not only print this message every second but use the time this coroutine
is sleeping to perform some other work. Let's extend our little example a bit.</p>
<p><span id="ticktock-example"></span></p>
<pre><code class="language-lua">--less_basic_spawn.lua
local cosock = require &quot;cosock&quot;

local function tick_task()
  while true do
    print(cosock.socket.gettime(), &quot;tick&quot;)
    cosock.socket.sleep(2)
  end
end

local function tock_task()
  cosock.socket.sleep(1)
  while true do
    print(cosock.socket.gettime(), &quot;tock&quot;)
    cosock.socket.sleep(2)
  end
end

cosock.spawn(tick_task, &quot;tick-task&quot;)
cosock.spawn(tock_task, &quot;tock-task&quot;)
cosock.run()
</code></pre>
<p>Very similar to our last example, this time we are spawning 2 coroutines one will print <code>&quot;tick&quot;</code> every two seconds
the other will wait 1 second and then print <code>&quot;tock&quot;</code> every two seconds. This should result in a line getting
printed to the terminal once a second alternating between our two strings. Notice though, there is a fair amount
of code duplication as <code>tick_task</code> and <code>tock_task</code> are nearly identical. This is mostly driven by the fact
that the first argument to <code>cosock.spawn</code> is a function that takes no arguments and returns no values which
means we can't ask cosock to pass in any arguments. One way we can get around this is by using
<a href="https://www.lua.org/pil/6.1.html">closures</a>. So instead of passing a function to
<code>cosock.spawn</code> we can <em>return</em> a function from another function and use it as the argument to <code>cosock.spawn</code>.
For example:</p>
<pre><code class="language-lua">--even_less_basic_spawn.lua
local cosock = require &quot;cosock&quot;

local function create_task(name, should_sleep_first)
  return function()
    if should_sleep_first then
      cosock.socket.sleep(1)
    end
    while true do
      print(cosock.socket.gettime(), name)
      cosock.socket.sleep(2)
    end
  end
end

cosock.spawn(create_task(&quot;tick&quot;, false), &quot;tick-task&quot;)
cosock.spawn(create_task(&quot;tock&quot;, true), &quot;tock-task&quot;)
cosock.run()
</code></pre>
<p>Notice here that <code>create_task</code> returns a function but takes a <code>name</code> argument and a <code>should_sleep_first</code>
argument which are available to our returned function.</p>
<p>Now, let's consider our <a href="%7E/../01-cosock.html#clientserver-example">first example</a> which may not look like it
but is very similar to our tick/tock example.</p>
<p>Instead of using <code>cosock.socket.sleep</code> to tell cosock we are waiting around for something, it uses
the <code>receive</code> method on a <code>cosock.socket.tcp</code>. Let's break down what is happening in that example.</p>
<img src="img/Client.svg" />
<p>To start, both tasks will be resumed which means that cosock has selected it to run, we can't say
for sure which task will get resumed first which is why we used a <code>cosock.channel</code> to make the
client task wait until the server was ready. Shortly after resuming, each task eventually calls
some method that will <code>yield</code> which means that it is waiting on <em>something</em> so cosock can run
another task. For the server, the first time we <code>yield</code> is in a call to <code>accept</code>, if the client
hasn't already called <code>connect</code> we would end up blocking so instead of blocking, we let another
task work, when we finally have a client connected cosock will wake us back up again. On the
client-side we first <code>yield</code> on a call to <code>channel:receive</code>, if the server hasn't sent the port
number we would end up blocking that task from calling <code>bind</code> so we let the other task work until
we finally have a port number and then cosock will wake us back up.</p>
<p>This pattern continues, each task running exclusively until it needs to wait for something yielding
control back to cosock. When the thing we were waiting for is ready, we can continue running again.</p>
<p>In both our tick/tock examples and our client/server example, we reach a point where cosock is just
handing control from task 1 to task 2 and back again in an infinite loop. In a more real-world
program, you might see any number of tasks, that need to be juggled. In our next example, we will
extend the client/server example to handle any number of clients.</p>
<p><span id="clientsserver-example"></span></p>
<pre><code class="language-lua">-- clients_server.lua
local cosock = require &quot;cosock&quot;
local socket = require &quot;cosock.socket&quot;
local ip = &quot;0.0.0.0&quot;
local server = socket.tcp()

local number_of_clients = 10

--- Since the clients and server are in the same application
--- we can use an OS assigned port and share it across the
--- two tasks, to coordinate the two tasks to start in the order
--- we want, we can use a cosock channel to make sure both tasks
--- have the same port number
local port_tx, port_rx = cosock.channel.new()

--- Spawn a task for handling the server side of the socket
cosock.spawn(function()
  server:bind(ip, 0)
  local _ip, p = server:getsockname()
  port_tx:send(p)
  server:listen()
  while true do
    local client = server:accept()
    cosock.spawn(function()
      while true do
        local request = assert(client:receive())
        print(string.format(&quot;received %q&quot;, request))
        if request:match(&quot;ping&quot;) then
          print(&quot;sending pong&quot;)
          client:send(&quot;pong\n&quot;)
        else
          client:close()
          break
        end
      end
    end)
  end
end, &quot;server task&quot;)

--- A single client task
---@param id integer The task's identifier
---@param port integer The server's port number
local function spawn_client(id, port)
  print(&quot;spawn_client&quot;, id, port)
  local client = socket.tcp()
  client:connect(ip, port)
  while true do    
    print(&quot;sending ping&quot;, id)
    client:send(string.format(&quot;ping %s\n&quot;, id))
    local request = assert(client:receive())
    assert(request == &quot;pong&quot;)
    socket.sleep(0.5)
  end
end

--- Wait for the port from the server task and then
--- spawn the `number_of_clients` client tasks
local function spawn_clients()
  local port = assert(port_rx:receive())
  for i=1,number_of_clients do
    cosock.spawn(function()
      spawn_client(i, port)
    end, string.format(&quot;client-task-%s&quot;, i))
  end
end

--- Spawn a bunch of client tasks
cosock.spawn(function()
  spawn_clients()
end, &quot;client task&quot;)

--- Finally we tell cosock to run all our coroutines until they are done
--- which should be forever
cosock.run()
</code></pre>
<p>Surprisingly little has changed. First, we updated the socket task to call <code>accept</code> more than once
and then pass the returned <code>client</code> into its own task to <code>receive</code>/<code>send</code> in a loop there.</p>
<p>For the client-side, we broke the client <code>send</code>/<code>receive</code> loop into its own task and added
a parent task to wait for the port number and then <code>cosock.spawn</code> a bunch of client tasks.</p>
<p>If you were to run this example, you would see that the print statements end up in random order!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="01.1-getting-started.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="03-channels.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="01.1-getting-started.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="03-channels.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
